from dotenv import load_dotenv
import os
import sys
import pandas as pd
import requests
import re


# Load the environment variables
load_dotenv()

# Get the API key and URL to check the IP from AbusedIPDB 
api_key_abip = os.getenv("API_KEY_ABUSEDIPDB")
url_abip = "https://api.abuseipdb.com/api/v2/check"

# Get the API key and URL to check the IP from VirusTotal
url_vt = f"https://www.virustotal.com/api/v3/ip_addresses/"
api_key_vt = os.getenv("API_KEY_VT")


# Function to check the IP from AbusedIPDB
def check_ip_abip(ip):
    # Headers to send to the API
    headers = {
        "Key": api_key_abip,
        "Accept": "application/json"
    }

    # Parameters to send to the API
    params = {
        "ipAddress": ip,
        "maxAgeInDays": 90,
        "verbose": "True"
    }

    try:
        # Call the API to check the IP
        response = requests.get(url_abip, headers=headers, params=params)
        data = response.json()     
        
        # Get the data from the response
        results = [
            data["data"]["abuseConfidenceScore"], 
            data["data"]["countryName"], 
            data["data"]["isp"], 
            data["data"]["domain"], 
            data["data"]["usageType"]
        ]

        return results
    except Exception as e:
        print(f"An error occured: {e}")
        return
    

# Function to check the IP from VirusTotal
def check_ip_vt(ip):
    # Headers to send to the API
    headers = {
        "x-apikey": api_key_vt
    }
    
    try:
        # Call the API to check the IP
        response = requests.get(url_vt+ip, headers=headers)
        data = response.json()     
        
        # Get the data from the response and check if any of the data is not in the response
        score = data["data"]["attributes"]["last_analysis_stats"]["malicious"] if not None else "No data available"
        country = data["data"]["attributes"]["country"] if not None else "No data available"
        as_owner = data["data"]["attributes"]["as_owner"] if not None else "No data available"
        whois = re.search(r"(\d+\.\d+\.\d+\.\d+)\s*-\s*(\d+\.\d+\.\d+\.\d+)", data["data"]["attributes"]["whois"])
        if whois is not None:
            whois = whois.group()
        
        results = [
            score, 
            country, 
            as_owner, 
            whois
        ]

        return results
    except Exception as e:
        print(f"An error occured: {e}")
        return
   

# Function to check the IPs and add the results to the df
def check_ips(data, opt):
    # Get the name of the first column 
    first_column = data.columns[0]

    # Apply function to every element in the column 
    # Use lambda (anonymous function) to pass the value to the function (check_ip), create a temp df, and then add the columns to the original df  
    if opt == "-a" or opt == "--abusedipdb":
        data[["AbuseConfidenceScore", "Country", "ISP", "Domain", "Usage"]] = data[first_column].apply(lambda x: pd.Series(check_ip_abip(x)))
    elif opt == "-v" or opt == "--virustotal":
        data[["VT Flagged Score", "Country", "Where", "IP Range"]] = data[first_column].apply(lambda x: pd.Series(check_ip_vt(x)))

    return data

# Function to read the csv file
def read_csv(file):
    try:
        # Read the file and return the data (only read the first column and use the first row as header)
        data = pd.read_csv(file, header=0)
        return data
    except FileNotFoundError:
        print("File not found. Please check the path and try again.")
        return
    except Exception as e:
        print(f"An error occured: {e}")
        return
    
# Function to write the data to a new csv file or the same file
def write_csv(data, file):
    try:
        # Write the data to the file
        data.to_csv("results.csv", index=False)
        print("File written successfully.")
    except Exception as e:
        print(f"An error occured: {e}")
        return
    

def main():
    # Check if the correct number of arguments is passed
    if len(sys.argv) != 3 and len(sys.argv) != 2:
        print("Use: python3 check_ip.py -h or --help")
        return

    # Help message
    if sys.argv[1] == "-h" or sys.argv[1] == "--help":
        print("Use: python3 check_ip.py <option> <file.csv>")
        print("Options:")
        print("-h, --help\tShow this help message")
        print("-a, --abusedipdb\tCheck the IPs using AbusedIPDB")
        print("-v, --virustotal\tCheck the IPs using VirusTotal")
        return 
    
    # Check if the correct arguments are passed
    if sys.argv[1] != "-a" and sys.argv[1] != "--abusedipdb" and sys.argv[1] != "-v" and sys.argv[1] != "--virustotal":
        print("Use: python3 check_ip.py -h or --help")
        return
    
    else:
        # Argument in postiion1 is the API to use
        opt = sys.argv[1]

        # Argument in position 2 is the file to read
        file = sys.argv[2]

        # Call the function to read the file
        data = read_csv(file)

        # Create a copy of the data to later compare if the ips were successfully checked
        temp = data.copy()

        # If the data is not None, call the function to check the IPs
        if data is not None:
            print("File read successfully...")
            print("Checking IPs...")
            data = check_ips(data, opt)
        
        # If the data is not None and the data is different from temp (the ips were checked correctly), call the function to write the data to a file
        if data is not None and not data.equals(temp):
            print("IPs checked successfully...")
            write_csv(data, file)
            print(data)
            print("Process completed.")
        else:
            print("An error occured. The file was not written.")
            print("Process failed.")


if __name__ == "__main__":
    main()